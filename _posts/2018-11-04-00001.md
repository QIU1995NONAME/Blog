---
layout: docs
title:  "NuttX 踩坑"
date:   2018-11-04
categories: NuttX
enable_mathjax: false
enable_mermaid: false
enable_comments: false
---
记录一些踩坑过程，暂时弃坑，有机会再填。

## 下载 NuttX 相关源代码
首先 创建一个目录，下面所有的命令都在这个目录中完成。
``` bash
$ git clone https://bitbucket.org/nuttx/nuttx.git      nuttx
$ git clone https://bitbucket.org/nuttx/apps.git       apps
$ git clone https://bitbucket.org/nuttx/buildroot.git  buildroot
$ git clone https://bitbucket.org/nuttx/tools.git      tools
$ git clone https://bitbucket.org/nuttx/uclibc.git     uClibc++
```
接着 切换这些仓库的分支
``` bash
$ pushd nuttx      ; git checkout nuttx-7.26     ; popd
$ pushd apps       ; git checkout nuttx-7.26     ; popd
$ pushd buildroot  ; git checkout buildroot-1.16 ; popd
```

## 构建 NuttX

### 编译 kconfig-frontend
```
$ pushd tools/kconfig-frontends
$ autoreconf
$ ./configure --disable-shared --prefix=${PWD}/__install__
$ make && make install
$ strip __install__/bin/*
$ cp __install__/bin/* $HOME/bin/   # ${HOME}/bin 已经配置在了 PATH 中
$ popd
```

### 配置 NuttX 源代码 ( 需要 arm-none-eabi-gcc )
```bash
$ pushd uClibc++
$ ./install.sh ../nuttx         # 此处需要 同意协议 GNU LGPL 3
$ popd
$ pushd nuttx
$ ./tools/configure.sh sabre-6quad/nsh
$ cat >> .config << __EOF__

CONFIG_HOST_LINUX=y                   # 必需
CONFIG_BUILD_2PASS=y                  # 必需
CONFIG_C99_BOOL8=y                    # 必需/极致坑爹的配置
CONFIG_LIBM=y                         # 必需
CONFIG_LIB_SYSCALL=y                  # 必需

CONFIG_ARCH_ADDRENV=y                 # 必需
CONFIG_BUILD_KERNEL=y                 # 必需
CONFIG_MM_PGALLOC=y                   # 必需


# CONFIG_NXFLAT=y               # 必需
# CONFIG_ELF=y                  # 必需
# CONFIG_LIBC_DLLFCN=y          # 必需
# CONFIG_LIBC_EXECFUNCS=y       # 必需

# CONFIG_UCLIBCXX=y             # 必需
# CONFIG_UCLIBCXX_EXCEPTION=n   # 必需/FIX BUG

__EOF__

$ make menuconfig               # 必需/其它自定义配置
        ###### 必须进行的配置
        # CONFIG_SYS_RESERVED=6                 # 必需
        # CONFIG_MM_PGSIZE                      # 自动/自定义
        # CONFIG_ARCH_TEXT_VBASE=0x10000000     # 必需/内存布局
        # CONFIG_ARCH_DATA_VBASE=0x20000000     # 必需/内存布局
        # CONFIG_ARCH_HEAP_VBASE=0x30000000     # 必需/内存布局

        ###### 以下配置可能有问题
        # CONFIG_ARCH_ADDRENV=y         # 必需
        #     CONFIG_ARCH_TEXT_NPAGES   # 必需/内存布局/自定义
        #     CONFIG_ARCH_DATA_NPAGES   # 必需/内存布局/自定义
        #     CONFIG_ARCH_HEAP_NPAGES   # 必需/内存布局/自定义


        # 
        # 
        #     CONFIG_SYS_RESERVED=6     # 必需
        #     CONFIG_SYS_NNEST=64       # 必需/自定义
        
        # CONFIG_ARCH_KERNEL_STACK=y    # 必需
        # CONFIG_ARCH_KERNEL_STACKSIZE  # 必需/自定义
        # CONFIG_UBOOT_UIMAGE=y         # 可选
        #   UIMAGE_LOAD_ADDRESS=???     # 可选/自定义
        #   UIMAGE_ENTRY_POINT=???      # 可选/自定义
        #
# make -j8
# popd
```

### 创建 NuttX 交叉工具链 (需要 gmp mpfr mpc)
``` bash
$ pushd buildroot
$ make menuconfig                # 此处需要调整以下项目
        # Target ARCH     : arm-generic     # 必需/自定义
        # Target ABI      : EABI            # 可选
        # Binutils        : 2.28.1
        # GCC (With C++)  : 7.3.0
        # Disable kconfig-frontend
$ make -j8
$ popd
```

## 构建部分常用软件库
``` bash
$ export NUTTX_ROOT
```

### Building zlib-1.2.11
``` bash
CC=arm-nuttx-eabi-gcc                              \
    CFLAGS="-DCONFIG_WCHAR_BUILTIN                 \
        -isystem ${NUTTX_ROOT}/include"            \
    ./configure --static --prefix=$PWD/__install__
make libz.a
make install
```

### Building libjpeg-turbo-1.5.3
``` bash
libtoolize
autoreconf
automake --add-missing
autoreconf
CFLAGS="-DCONFIG_WCHAR_BUILTIN                     \
        -isystem ${NUTTX_ROOT}/include/arch        \
        -isystem ${NUTTX_ROOT}/include             \
        -DSIZE_MAX=4294967295UL"                   \
    ./configure --host=arm-nuttx-eabi              \
        --enable-shared=no --enable-static=yes     \
        --prefix=$PWD/__install__                  \
        --without-turbojpeg --without-simd
make libjpeg.la -j8
make install-libLTLIBRARIES install-data
```

### Building tiff-4.0.9
``` bash
CFLAGS="-DCONFIG_WCHAR_BUILTIN                     \
        -isystem ${NUTTX_ROOT}/include/arch        \
        -isystem ${NUTTX_ROOT}/include"            \
    CXXFLAGS="                                     \
        -isystem ${NUTTX_ROOT}/include/cxx"        \
    ./configure --host=arm-nuttx-eabi              \
        --enable-shared=no --enable-static=yes     \
        --prefix=$PWD/__install__
pushd port ; make -j8 ; popd
cd libtiff
make libtiff.la -j8
make install-libLTLIBRARIES install-data
```

### Building libpng-1.6.35
``` bash
CFLAGS="-DCONFIG_WCHAR_BUILTIN                     \
        -isystem ${NUTTX_ROOT}/include/arch        \
        -isystem ${NUTTX_ROOT}/include"            \
    CXXFLAGS="                                     \
        -isystem ${NUTTX_ROOT}/include/cxx"        \
    ./configure --host=arm-nuttx-eabi              \
        --enable-shared=no --enable-static=yes     \
        --prefix=$PWD/__install__

```



