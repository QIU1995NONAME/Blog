---
layout: docs
title:  "虚拟机安装 Gentoo"
date:   2017-12-22
categories: Linux Gentoo
enable_mathjax: false
enable_mermaid: false
---
主要按照<https://wiki.gentoo.org>上面的指示进行操作。

<hr>
# 准备安装 Gentoo

## 主机环境
+ Linux 4.14.8-300.fc27.x86_64
+ VirtualBox 5.2.4

## 虚拟机基本配置
+ CPU 核心数: 4 (把核心给多一点肯定没错)
+ EFI:  启用
+ 内存： 4G
+ (SATA 0) 硬盘: 12G (普通)
+ (SATA 1) 硬盘: 24G (完全写入)
+ (SATA 2) 硬盘: 16G (完全写入)
+ (SATA 4) 光盘: Fedora 27 Live CD (仅仅用作启动盘)
+ 虚拟网卡：2个
    0. Host-Only
    0. NAT

## 启动虚拟机

使用 Fedora 的 LiveCD 启动到界面，使得虚拟机可以连接到外部的网络。

<hr>
# 安装 Gentoo

## 使用 gdisk 为硬盘进行分区

由于是在新创建的虚拟机中，所以直接使用下述命令即可进行分区。

``` bash
(Fedora Live) $ gdisk /dev/sda
(Fedora Live) $ gdisk /dev/sdb
(Fedora Live) $ gdisk /dev/sdc
```

否则，建议使用 lsblk 等命令进行确认。以下是本人分区完成后使用 gdisk -l 的结果:

```
(Fedora Live) $ gdisk /dev/sda -l
Partition table scan:
  MBR: protective
  BSD: not present
  APM: not present
  GPT: present
...

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048          133119   64.0 MiB    EF00  EFI System
   2          133120         2099199   960.0 MiB   8300  Linux filesystem
   3         2099200        25165790   11.0 GiB    8300  Linux filesystem

(Fedora Live) $ gdisk /dev/sdb -l
...

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048        50331614   24.0 GiB    8300  Linux filesystem

(Fedora Live) $ gdisk /dev/sdc -l
...

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         8390655   4.0 GiB     8200  Linux swap
   2         8390656        33554398   12.0 GiB    8300  Linux filesystem
```

## 格式化各个分区并挂载

``` bash
(Fedora Live) $ sudo mkfs.vfat  /dev/sda1
(Fedora Live) $ sudo mkfs.xfs   /dev/sda2
(Fedora Live) $ sudo mkfs.xfs   /dev/sda3
(Fedora Live) $ sudo mkfs.xfs   /dev/sdb1
(Fedora Live) $ sudo mkswap     /dev/sdc1
(Fedora Live) $ sudo mkfs.xfs   /dev/sdc2
(Fedora Live) $ cd /mnt
(Fedora Live) $ sudo mkdir gentoo
(Fedora Live) $ sudo mount /dev/sda3 gentoo
(Fedora Live) $ cd gentoo
(Fedora Live) $ sudo mkdir boot
(Fedora Live) $ sudo mkdir AAAA
(Fedora Live) $ sudo mkdir var/tmp -p
(Fedora Live) $ sudo mount /dev/sda2 boot
(Fedora Live) $ sudo mount /dev/sdb1 AAAA
(Fedora Live) $ sudo mount /dev/sdc2 var/tmp
(Fedora Live) $ cd boot
(Fedora Live) $ sudo mkdir efi
(Fedora Live) $ sudo mount /dev/sda1 efi
(Fedora Live) $ sudo swapon /dev/sda3
```

使用 lsblk 命令查看挂载情况

```
(Fedora Live) $ lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda           8:0    0   12G  0 disk
├─sda1        8:1    0   64M  0 part /mnt/gentoo/boot/efi
├─sda2        8:2    0  960M  0 part /mnt/gentoo/boot
└─sda3        8:3    0   11G  0 part /mnt/gentoo
sdb           8:16   0   24G  0 disk
└─sdb1        8:17   0   24G  0 part /mnt/gentoo/AAAA
sdc           8:32   0   16G  0 disk
├─sdc1        8:33   0    4G  0 part [SWAP]
└─sdc2        8:34   0   12G  0 part /mnt/gentoo/var/tmp

```

## 下载并解压 stage4
使用 Fedora Live CD 中自带的 Firefox 即可完成下载。下载完成后将 stage4 拷贝到 /mnt/gentoo。解压缩时按照官网提供的解压缩命令进行解压缩，完成之后删除下载的 stage4 文件。

``` bash
(Fedora Live) $ sudo tar -xvjpf stage4-*.tar.bz2 --xattrs --numeric-owner
(Fedora Live) $ sudo rm stage4-*.tar.bz2
```

## 配置 Gentoo 基础系统
此处主要按照官网的指示进行操作。但是建议将某些费时的操作放到之后完成。这一步应当仅仅进行那些不费时的操作。

``` bash
(Fedora Live) $ sudo mkdir /mnt/gentoo/etc/portage/repos.conf
(Fedora Live) $ sudo cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
(Fedora Live) $ sudo cp -L /etc/resolv.conf /mnt/gentoo/etc/
(Fedora Live) $ sudo mount -t proc /proc /mnt/gentoo/proc
(Fedora Live) $ sudo mount --rbind /sys /mnt/gentoo/sys
(Fedora Live) $ sudo mount --make-rslave /mnt/gentoo/sys
(Fedora Live) $ sudo mount --rbind /dev /mnt/gentoo/dev
(Fedora Live) $ sudo mount --make-rslave /mnt/gentoo/dev
```

## 切换到新环境并作出必要的配置

``` bash
# 进入新的环境
(Fedora Live) $ sudo chroot /mnt/gentoo /bin/bash
(chroot gentoo) . /etc/profile

# 安装 ebuild 数据库快照
(chroot gentoo) echo -e "GENTOO_MIRRORS=\"http://mirrors.163.com/gentoo/\"" >> /etc/portage/make.conf
(chroot gentoo) emerge-webrsync

# 选择一个 profile (default/linux/amd64/17.0/systemd)
(gentoo root) eselect profile list
(gentoo root) eselect profile set <no.>

# 配置地区
(chroot gentoo) echo -e "en_US.UTF-8 UTF-8\nzh_CN.UTF-8 UTF-8" > /etc/locale.gen
(chroot gentoo) locale-gen
(chroot gentoo) eselect locale list # 找到 en_US.UTF8，将序号补在下面的命令中
(chroot gentoo) eselect locale set <no.>
(chroot gentoo) env-update

# 配置时区
(chroot gentoo) echo "Asia/Shanghai" > /etc/timezone
(chroot gentoo) emerge --config sys-libs/timezone-data

# 预安装 GRUB2
(chroot gentoo) echo 'GRUB_PLATFORMS="efi-64"' >> /etc/portage/make.conf
(chroot gentoo) emerge -auDN sys-boot/grub:2

# 安装必要的软件
(chroot gentoo) emerge -a gentoolkit
(chroot gentoo) emerge -a xfsprogs
(chroot gentoo) emerge -a dracut
(chroot gentoo) emerge -a networkmanager
```

## 安装内核

``` bash
# 安装内核源代码
(chroot gentoo) emerge -a gentoo-sources:4.9.72
```

在使用了 Fedora 的配置 (来自LiveCD) 基础上，再修改配置。make 

``` bash
(chroot gentoo) cd /usr/src/linux
# 配置
(chroot gentoo) make menuconfig
# 编译
(chroot gentoo) make -j8
# 安装
(chroot gentoo) make modules_install
(chroot gentoo) make install
# 清理
(chroot gentoo) make clean
# 生成initramfs
(chroot gentoo) dracut --kver 4.9.72-gentoo
```

## 重启之前最后的配置

``` bash
# 配置 GRUB2
(chroot gentoo) grub-install --efi-directory=/boot/efi
(chroot gentoo) grub-mkconfig -o /boot/grub/grub.cfg

# 配置 Root Password
(chroot gentoo) passwd

# 配置 fstab
(chroot gentoo) nano /etc/fstab
(chroot gentoo) cat  /etc/fstab
/dev/sda1 /boot/efi vfat  umask=0077,shortname=winnt   0 2
/dev/sda2 /boot     xfs   defaults,noatime             0 0
/dev/sda3 /         xfs   defaults,noatime             0 0
/dev/sdb1 /AAAA     xfs   defaults,noatime             0 0
/dev/sdc1 swap      swap  defaults                     0 0
/dev/sdc2 /var/tmp  xfs   defaults,noatime             0 0

```


## 重新启动
+ 关机时，绝对不要强行关机。使用正常流程关机就好了。
+ 关机状态下，移除光盘。
+ 为虚拟机打快照。

<hr>
# 调整 Gentoo 系统

## 第一次配置 (只可以在本地配置)

``` bash
(gentoo root) systemctl enable sshd           # 启动必要的系统服务
(gentoo root) systemctl enable NetworkManager # 启动必要的系统服务
(gentoo root) visudo                          # 将 wheel 组的设置解除注释
(gentoo root) useradd admin                   # 创建管理员用户 可以自己定义用户名
(gentoo root) passwd admin                    # 修改管理员用户密码
(gentoo root) usermod -a -G wheel admin       # 使得管理员用户真正拥有管理员权限
(gentoo root) init 0                          # 关机, 打快照
```

## 第二次配置 (可以通过 ssh 配置)

``` bash
(gentoo) $ sudo emerge -a emacs vim zsh
(gentoo) $ sudo emerge -a dev-vcs/git
(gentoo) $ sudo emerge -a app-text/tree
(gentoo) $ sudo emerge -a linux-firmware

(gentoo) $ sudo emerge -a ncurses:5
(gentoo) $ sudo emerge -a xorg-server
(gentoo) $ sudo emerge -a virtual/jdk
(gentoo) $ sudo emerge -a mariadb
(gentoo) $ sudo emerge -auDN @world                 # 更新整个系统
(gentoo) $ sudo emerge -a --depclean                # 更新整个系统
(gentoo) $ sudo revdep-rebuild

(gentoo) $ sudo usermod -s /bin/zsh admin           # 设置 ZSH 为登陆 shell
(gentoo) $ sudo emerge -a --unmerge nano            # 本人不喜欢使用 nano
(gentoo) $ sudo hostnamectl set-hostname '....'     # 设置主机名称
(gentoo) $ sudo eselect editor list                 # 找到刚才安装的 vi
(gentoo) $ sudo eselect editor set <no.>

```

## 清理多余的快照，并打下当前状态的快照(略)
