---
layout: docs
title:  "虚拟机安装 Gentoo"
date:   2017-12-22
categories: Linux Gentoo
enable_mathjax: false
enable_mermaid: false
---
主要按照<https://wiki.gentoo.org>上面的指示进行操作。

<hr>
# 准备安装 Gentoo

## 主机环境
+ Linux 4.14.6-300.fc27.x86_64
+ VirtualBox 5.2.4

## 虚拟机基本配置
+ CPU 核心数: 4 (把核心给多一点肯定没错)
+ 内存： 2G
+ (SATA 0) 硬盘: 32G
+ (SATA 4) 光盘: Fedora 27 Live CD (仅仅用作启动盘)
+ 虚拟网卡：2个
    0. Host-Only
    0. NAT

## 启动虚拟机

使用 Fedora 的 LiveCD 启动到界面，使得虚拟机可以连接到外部的网络。

<hr>
# 安装 Gentoo

## 使用 fdisk 为硬盘进行分区

由于是在新创建的虚拟机中，所以直接使用下述命令即可进行分区。

```bash
(Fedora Live) $ fdisk /dev/sda
```

否则，建议使用 lsblk 等命令进行确认。以下是本人分区完成后使用 fdisk -l 的结果:

```
/dev/sda1  *       2048  2099199  2097152   1G 83 Linux
/dev/sda2       2099200  4196351  2097152   1G 82 Linux swap / Solaris
/dev/sda3       4196352 67108863 62912512  30G 83 Linux
```

## 格式化各个分区并挂载

```bash
(Fedora Live) $ sudo mkfs.xfs  /dev/sda1
(Fedora Live) $ sudo mkswap    /dev/sda2
(Fedora Live) $ sudo mkfs.xfs  /dev/sda3
(Fedora Live) $ cd /mnt
(Fedora Live) $ sudo mkdir gentoo
(Fedora Live) $ sudo mount /dev/sda3 gentoo
(Fedora Live) $ cd gentoo
(Fedora Live) $ sudo mkdir boot
(Fedora Live) $ sudo mount /dev/sda1 boot
(Fedora Live) $ sudo swapon /dev/sda2
```

使用 lsblk 命令查看挂载情况

```
(Fedora Live) $ lsblk
sda           8:0    0   32G  0 disk
├─sda1        8:1    0    1G  0 part /mnt/gentoo/boot
├─sda2        8:2    0    1G  0 part [SWAP]
└─sda3        8:3    0   30G  0 part /mnt/gentoo
```

## 下载并解压 stage3
使用 Fedora Live CD 中自带的 Firefox 即可完成下载。下载完成后将 stage3 拷贝到 /mnt/gentoo。解压缩时按照官网提供的解压缩命令进行解压缩，完成之后删除下载的 stage3 文件。

```bash
(Fedora Live) $ sudo tar -xvjpf stage3-*.tar.bz2 --xattrs --numeric-owner
(Fedora Live) $ sudo rm stage3-*.tar.bz2
```

## 配置 Gentoo 基础系统
此处主要按照官网的指示进行操作。但是建议将某些费时的操作放到之后完成。这一步应当仅仅进行那些不费时的操作。

```bash
(Fedora Live) $ mkdir /mnt/gentoo/etc/portage/repos.conf
(Fedora Live) $ sudo cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
(Fedora Live) $ sudo cp -L /etc/resolv.conf /mnt/gentoo/etc/
(Fedora Live) $ sudo mount -t proc /proc /mnt/gentoo/proc
(Fedora Live) $ sudo mount --rbind /sys /mnt/gentoo/sys
(Fedora Live) $ sudo mount --make-rslave /mnt/gentoo/sys
(Fedora Live) $ sudo mount --rbind /dev /mnt/gentoo/dev
(Fedora Live) $ sudo mount --make-rslave /mnt/gentoo/dev
```

## 切换到新环境并作出必要的配置

接下来，进入新的环境。并作出必要的配置

```bash
(Fedora Live) $ sudo chroot /mnt/gentoo /bin/bash
(chroot gentoo) . /etc/profile
```

### 安装 ebuild 数据库快照

```bash
(chroot gentoo) emerge-webrsync
```

暂时不要使用emerge --sync进行更新，这一步等到重新启动之后再进行。

### 配置时区

```bash
(chroot gentoo) echo "Asia/Shanghai" > /etc/timezone
(chroot gentoo) emerge --config sys-libs/timezone-data
```

### 配置地区

```bash
(chroot gentoo) echo -e "en_US.UTF-8 UTF-8\nzh_CN.UTF-8 UTF-8" > /etc/locale.gen
(chroot gentoo) locale-gen
(chroot gentoo) eselect locale list # 找到 en_US.UTF8，将序号补在下面的命令中
(chroot gentoo) eselect locale set <no.>
(chroot gentoo) env-update
```

### 预安装 GRUB2
```bash
(chroot gentoo) emerge --ask --update --newuse --verbose sys-boot/grub:2
```

## 安装内核

本次安装内核仅仅为了启动系统，所以使用简单配置即可。复杂的定制内核的任务放到重启之后进行。

```bash
(chroot gentoo) emerge --ask sys-kernel/gentoo-sources sys-kernel/genkernel
(chroot gentoo) cd /usr/src/linux
(chroot gentoo) make defconfig
(chroot gentoo) make menuconfig
```

在使用了默认的配置基础上，再修改配置，以支持根操作系统的FS格式，以及开启EFI的支持。

```
File systems --->
  <*> XFS filesystem support
```

保存，并开始编译内核。

```bash
(chroot gentoo) make -j8
(chroot gentoo) make modules_install
(chroot gentoo) make install
```

生成一个initramfs

```bash
(chroot gentoo) genkernel --install initramfs
```

## 配置系统，准备重启

### 安装必要的软件
这里所谓的，必要的软件，指的并不是常用软件，而是系统启动所必须的软件。

```bash
# 文件系统工具
(chroot gentoo) emerge --ask sys-fs/xfsprogs
# DHCP客户端
(chroot gentoo) emerge --ask net-misc/dhcpcd
```

### 配置fstab

```bash
$ cat /etc/fstab
/dev/sda1 /boot     xfs   defaults,noatime             0 0
/dev/sda2 swap      swap  defaults                     0 0
/dev/sda3 /         xfs   defaults,noatime             0 0
```

### Root Password

```bash
(chroot gentoo) passwd
```

### 安装与配置 GRUB2

```bash
(chroot gentoo) grub-install /dev/sda
(chroot gentoo) grub-mkconfig -o /boot/grub/grub.cfg
```

## 重新启动
+ 关机时，绝对不要强行关机。使用正常流程关机就好了。
+ 关机状态下，移除光盘。
+ 为虚拟机打快照。

<hr>
# 调整 Gentoo 系统

目前我们做到了，也仅仅做到了从硬盘启动 Gentoo 。接下来要进行一系列的配置，包括前面跳过的步骤。

## 选择一个 profile 并重新构建整个系统

```bash
(gentoo root) eselect profile list
# 我选择了 default/linux/amd64/17.0/systemd
(gentoo root) eselect profile set <no.>
(gentoo root) emerge --ask --update --deep --newuse @world
```

关于使内核支持 systemd 的配置，请查询 WIKI 。

修改 /etc/default/grub 取消注释 GRUB_CMDLINE_LINUX 开头的配置，使得 systemd 成为一号进程。

## 使用 dracut 替换 genkernel

```bash
(gentoo root) emerge --ask --unmerge sys-kernel/genkernel
(gentoo root) emerge --ask sys-kernel/dracut
(gentoo root) dracut # 重新生成 initramfs 文件
(gentoo root) grub-mkconfig -o /boot/grub/grub.cfg # 重新生成 GRUB 配置文件
```

## 重新启动 (同上，做快照)

## 继续调整

```bash
(gentoo root) systemctl enable systemd-networkd   # 开机自动启动 networkd
(gentoo root) systemctl start  systemd-networkd   # 本次手动启动 networkd
(gentoo root) hostnamectl set-hostname '....'     # 设置主机名称
(gentoo root) emerge --ask sudo vim zsh   # 安装必要的软件
(gentoo root) emerge --ask dev-vcs/git    # 安装必要的软件
(gentoo root) emerge --ask mirrorselect   # 安装必要的软件
(gentoo root) mirrorselect -i             # 选择一个速度快的镜像
(gentoo root) emerge --ask linux-firmware # 安装必要的软件
(gentoo root) emerge --ask --unmerge nano # 本人不喜欢使用 nano
(gentoo root) eselect editor list         # 找到刚才安装的 vi
(gentoo root) eselect editor set <no.>
(gentoo root) visudo                      # 将 wheel 组的设置解除注释
(gentoo root) useradd admin               # 创建管理员用户 可以自己定义用户名
(gentoo root) passwd admin                # 修改管理员用户密码
(gentoo root) usermod -a -G wheel admin   # 使得管理员用户真正拥有管理员权限
(gentoo root) su admin                    # 切换到管理员用户
(gentoo) $ sudo rm /root/.bash_history # 清理历史纪录
(gentoo) $ sudo rm /root/.viminfo      # 清理历史纪录
(gentoo) $ cd                          # 切换到$HOME目录

(gentoo) $ git clone git://github.com/QIU1995NONAME/oh-my-zsh # 安装本人 fork 的一份 oh-my-zsh
(gentoo) $ mv oh-my-zsh .oh-my-zsh
(gentoo) $ cp .oh-my-zsh/templates/zshrc.zsh ./.zshrc
(gentoo) $ sudo /sbin/init 0           # 关机
```

## 清理多余的快照，并打下当前状态的快照(略)
