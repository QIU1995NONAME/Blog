---
layout: docs
title:  "Gentoo 创建适用于 ARM 的基础系统"
date:   2018-10-07
categories: Linux Gentoo ARM
enable_mathjax: false
enable_mermaid: false
enable_comments: true
---

## 说在前面
主要来自于 <https://wiki.gentoo.org> 上面的信息。

## 安装并配置 QEMU
``` bash
###### 配置 QEMU USE
$ cat << EOF | sudo tee /etc/portage/package.use/app-emulation_qemu
app-emulation/qemu gnutls lzo smartcard snappy static-user xfs 
app-emulation/qemu qemu_softmmu_targets_x86_64 qemu_softmmu_targets_i386 qemu_softmmu_targets_aarch64 qemu_softmmu_targets_arm
app-emulation/qemu qemu_user_targets_x86_64    qemu_user_targets_i386    qemu_user_targets_aarch64    qemu_user_targets_arm

EOF
###### 安装 QEMU 并生成二进制包
$ sudo emerge -a --buildpkg app-emulation/qemu
```

## 安装并配置 Crossdev
### 安装 Crossdev

``` bash
$ sudo emerge -a crossdev
```

### 配置 Crossdev 的 portage
``` bash
$ sudo mkdir -p /usr/local/crossdev/portage/{profiles,metadata}
$ echo 'crossdev' | sudo tee /usr/local/crossdev/portage/profiles/repo_name
$ echo 'masters = gentoo' | sudo tee /usr/local/crossdev/portage/metadata/layout.conf
$ cat << EOF | sudo tee /etc/portage/repos.conf/crossdev.conf
[crossdev]
location = /usr/local/crossdev/portage
priority = 10
masters = gentoo
auto-sync = no

EOF
```

### 使用 Crossdev 安装交叉工具链
``` bash
$ sudo crossdev --stable -s4 -t aarch64-unknown-linux-gnu
$ sudo crossdev --stable -s4 -t arm-unknown-linux-gnueabi

```

## 配置基本系统

``` bash
###### 创建临时文件夹
$ sudo mkdir -p /var/tmp/{aarch64-unknown-linux-gnu,arm-unknown-linux-gnueabi}
$ sudo chmod 777 /var/tmp/{aarch64-unknown-linux-gnu,arm-unknown-linux-gnueabi}
$ sudo chmod +t /var/tmp/{aarch64-unknown-linux-gnu,arm-unknown-linux-gnueabi}

###### 配置 make.conf
## 仅使用稳定版软件
##  ACCEPT_KEYWORDS 删除 ~arm(64)
##  
##  GENTOO_MIRRORS="http://mirrors.163.com/gentoo/"
##  DISTDIR="/usr/portage/distfiles/"
##  PKGDIR="/usr/portage/packages/${CHOST}/"
##  PORTAGE_TMPDIR="/var/tmp/${CHOST}/"
##

$ sudo vim /usr/aarch64-unknown-linux-gnu/etc/portage/make.conf
$ sudo vim /usr/arm-unknown-linux-gnueabi/etc/portage/make.conf

###### 配置 profile
$ sudo rm /usr/aarch64-unknown-linux-gnu/etc/portage/make.profile
$ sudo ln -svf /usr/portage/profiles/default/linux/arm64/17.0/systemd \
> /usr/aarch64-unknown-linux-gnu/etc/portage/make.profile

$ sudo rm /usr/arm-unknown-linux-gnueabi/etc/portage/make.profile
$ sudo ln -svf /usr/portage/profiles/default/linux/arm/17.0 \
> /usr/arm-unknown-linux-gnueabi/etc/portage/make.profile

###### 安装内核源代码
$ sudo aarch64-unknown-linux-gnu-emerge -a --nodeps gentoo-sources:4.14.72
$ sudo arm-unknown-linux-gnueabi-emerge -a --nodeps gentoo-sources:4.14.72

###### 配置内核源代码
$ cd /usr/aarch64-unknown-linux-gnu/usr/src/linux
$ sudo make ARCH=arm64 CROSS_COMPILE=aarch64-unknown-linux-gnu- menuconfig
$ cd /usr/arm-unknown-linux-gnueabi/usr/src/linux
$ sudo make ARCH=arm   CROSS_COMPILE=arm-unknown-linux-gnueabi- menuconfig

###### 安装运行在 ARM64/ARM 系统上的 Binutils GCC Python ...
$ sudo aarch64-unknown-linux-gnu-emerge -au1 binutils gcc python:2.7 python:3.6
$ sudo arm-unknown-linux-gnueabi-emerge -au1 binutils gcc python:2.7 python:3.6

###### 配置需要链接配置的软件包
$ sudo aarch64-unknown-linux-gnu-emerge -au1 dev-libs/libassuan sys-libs/ncurses
$ sudo arm-unknown-linux-gnueabi-emerge -au1 dev-libs/libassuan sys-libs/ncurses

###### 链接配置
$ export TGT=aarch64-unknown-linux-gnu
$ export TGT=arm-unknown-linux-gnueabi
$ export TGT=

sudo ln -svf /usr/${TGT}/usr/bin/ncurses6-config  /usr/local/bin/${TGT}-ncurses6-config;
sudo ln -svf /usr/${TGT}/usr/bin/ncursesw6-config /usr/local/bin/${TGT}-ncursesw6-config;
sudo ln -svf /usr/${TGT}/usr/bin/libassuan-config /usr/local/bin/${TGT}-libassuan-config;

```

### 将 QEMU 二进制安装到 TARGET 中
``` bash
###### 将 HOST 中的 qemu ，二进制安装到 TARGET 中
$ sudo ROOT=/usr/aarch64-unknown-linux-gnu emerge -a1 --nodeps --usepkgonly qemu
$ sudo ROOT=/usr/arm-unknown-linux-gnueabi emerge -a1 --nodeps --usepkgonly qemu

###### binfmt
$ cat << EOF | sudo tee /etc/binfmt.d/qemu-aarch64-arm-static.conf
:qemu-aarch64:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xb7\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-aarch64:
:qemu-arm:M::\x7fELF\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x28\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-arm:

EOF

$ sudo systemctl restart systemd-binfmt.service

```

### 配置 ARM64 基本系统
``` bash
###### 安装基本系统和其他必要的软件 (要保证这些命令成功结束)
$ sudo aarch64-unknown-linux-gnu-emerge -auDN --keep-going @world
$ sudo aarch64-unknown-linux-gnu-emerge -au1  --keep-going \
> $(egrep '^[a-z]+' /usr/portage/profiles/default/linux/packages.build)

$ sudo aarch64-unknown-linux-gnu-emerge -au gentoolkit

###### 可能需要用到的，解除依赖循环的命令
$ sudo USE="-systemd -udev" aarch64-unknown-linux-gnu-emerge -au1 \
> sys-process/procps sys-apps/util-linux

$ sudo aarch64-unknown-linux-gnu-emerge -au --keep-going @world

```

### 配置 ARM 基本系统
``` bash
###### 安装基本系统(会报错)
$ sudo arm-unknown-linux-gnueabi-emerge -auDN --keep-going @world

###### 由于 Python Native Extensions 对交叉编译的支持有问题，但是 portage 必须安装成功，所以用下面的命令暂时绕过问题。
$ sudo \
> USE="-python_targets_python2_7 -native-extensions" \
> CFLAGS="-I/usr/arm-unknown-linux-gnueabi/usr/include/python3.6" \
> LDFLAGS="-L/usr/arm-unknown-linux-gnueabi/usr/lib" \
> arm-unknown-linux-gnueabi-emerge -au --keep-going @world

###### 安装其他必要的软件
$ sudo arm-unknown-linux-gnueabi-emerge -au1 --keep-going \
> $(egrep '^[a-z]+' /usr/portage/profiles/default/linux/packages.build)

###### chroot 到新的系统，进行接下来的配置
##     删除部分 make.conf 中的配置
$ cd /usr/arm-unknown-linux-gnueabi
$ sudo mkdir -p dev sys usr/portage proc
$ sudo mount --bind /proc proc
$ sudo mount --bind /dev  dev
$ sudo mount --bind /sys  sys
$ sudo mount --bind /usr/portage usr/portage
$ sudo mount --bind /var/tmp/arm-unknown-linux-gnueabi var/tmp
$ sudo cp /etc/locale.gen /etc/resolv.conf etc/
$ sudo chroot .

(chroot) ldconfig
(chroot) locale-gen
(chroot) emerge -auN  portage
(chroot) emerge -auDN @world

###### 上面的命令依旧会报错，退出 chroot 回到主系统
$ sudo arm-unknown-linux-gnueabi-emerge -auDN --keep-going @world

###### 配置/安装 GRUB 冷静一下
$ sudo mkdir -p /usr/arm-unknown-linux-gnueabi/etc/portage/{package.keywords,package.use}

$ cat << EOF | sudo tee /usr/arm-unknown-linux-gnueabi/etc/portage/package.use/sys-boot_grub
sys-boot/grub -themes grub_platforms_uboot
EOF

$ cat << EOF | sudo tee /usr/arm-unknown-linux-gnueabi/etc/portage/package.keywords/sys-boot_grub
=sys-boot/grub-2.02-r3 **
EOF

$ sudo arm-unknown-linux-gnueabi-emerge -au grub
```
