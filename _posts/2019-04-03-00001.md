---
layout: docs
title:  "Gentoo 创建适用于 ARM 的基础系统 (Updated)"
date:   2019-04-03
categories: Linux Gentoo ARM
enable_mathjax: false
enable_mermaid: false
enable_comments: true
---

## 说在前面
主要来自于 <https://wiki.gentoo.org> 上面的信息。

## 安装并配置 QEMU
``` bash
###### 配置 QEMU USE
$ cat << __EOF__ | sudo tee /etc/portage/package.use/app-emulation_qemu
app-emulation/qemu gnutls lzo smartcard snappy static-user xfs
app-emulation/qemu qemu_softmmu_targets_x86_64 qemu_softmmu_targets_i386 qemu_softmmu_targets_aarch64 qemu_softmmu_targets_arm
app-emulation/qemu qemu_user_targets_x86_64    qemu_user_targets_i386    qemu_user_targets_aarch64    qemu_user_targets_arm
__EOF__

###### 安装 QEMU
$ sudo emerge -a app-emulation/qemu
```

## 安装并配置 Crossdev
### 安装 Crossdev

``` bash
$ sudo emerge -a crossdev
```

### 配置 Crossdev 的 portage
``` bash
$ sudo mkdir -p /usr/local/crossdev/portage/{profiles,metadata}
$ echo 'crossdev' | sudo tee /usr/local/crossdev/portage/profiles/repo_name
$ echo 'masters = gentoo' | sudo tee /usr/local/crossdev/portage/metadata/layout.conf
$ cat << __EOF__ | sudo tee /etc/portage/repos.conf/crossdev.conf
[crossdev]
location = /usr/local/crossdev/portage
priority = 10
masters = gentoo
auto-sync = no
__EOF__
```

### 初始化交叉环境
``` bash
$ sudo crossdev --stable --init-target -t arm-unknown-linux-gnueabi
$ sudo mkdir -p  /var/tmp/arm-unknown-linux-gnueabi
$ sudo chmod 777 /var/tmp/arm-unknown-linux-gnueabi
$ sudo chmod +t  /var/tmp/arm-unknown-linux-gnueabi
$ sudo vim /usr/arm-unknown-linux-gnueabi/etc/portage/make.conf
  ###### 主要修改以下内容
  ##     ACCEPT_KEYWORDS="${ARCH}"    # 删除 '～${ARCH}'
  ##     USE="${ARCH} -pam -fortran"  # 添加 '-fortran'
  ##     GENTOO_MIRRORS="http://mirrors.163.com/gentoo/"
  ##     DISTDIR="/usr/portage/distfiles/"
  ##     PKGDIR="/usr/portage/packages/${CHOST}/"
  ##     PORTAGE_TMPDIR="/var/tmp/${CHOST}/"
$ sudo rm /usr/arm-unknown-linux-gnueabi/etc/portage/make.profile
$ sudo ln -svf /usr/portage/profiles/default/linux/arm/17.0/armv7a \
      /usr/arm-unknown-linux-gnueabi/etc/portage/make.profile
```

### 手动安装工具链
``` bash
$ sudo emerge -a cross-arm-unknown-linux-gnueabi/binutils
$ sudo USE="headers-only" emerge -a1 \
      cross-arm-unknown-linux-gnueabi/linux-headers \
      cross-arm-unknown-linux-gnueabi/glibc

$ sudo USE="-cxx -nls -vtv -sanitize -openmp" emerge -a1 cross-arm-unknown-linux-gnueabi/gcc
$ sudo emerge -aN \
      cross-arm-unknown-linux-gnueabi/linux-headers \
      cross-arm-unknown-linux-gnueabi/glibc

$ sudo emerge -aN cross-arm-unknown-linux-gnueabi/gcc
```

### 拷贝 qemu 可执行文件，并设置 binfmt
``` bash
$ sudo cp /usr/bin/qemu-arm /usr/arm-unknown-linux-gnueabi/usr/bin/qemu-arm
$ cat << __EOF__ | sudo tee /etc/binfmt.d/qemu-aarch64-arm-static.conf
:qemu-aarch64:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xb7\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-aarch64:
:qemu-arm:M::\x7fELF\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x28\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-arm:
__EOF__

$ sudo systemctl restart systemd-binfmt.service
```

### 调整 Target Root
``` bash
$ cd /usr/arm-unknown-linux-gnueabi
$ sudo mkdir -p dev sys usr/portage proc
$ sudo ln -svf lib lib64
$ sudo ln -svf lib usr/lib64
```

### 安装基本软件
``` bash
$ sudo arm-unknown-linux-gnueabi-emerge -au1 --keep-going \
       binutils gcc python:2.7 python:3.6 perl openrc     \
       libtool iproute2 e2fsprogs busybox gperf openssh   \
       unzip
$ sudo arm-unknown-linux-gnueabi-emerge -au --keep-going  \
       sudo app-text/tree
$ sudo arm-unknown-linux-gnueabi-emerge -au1 --keep-going \
       $(egrep '^[a-z]+' /usr/portage/profiles/default/linux/packages.build)
  ###### 由于 Python Native Extensions 对交叉编译的支持有问题，但是 portage 等一些必要软件必须安装成功，所以用下面的命令暂时绕过问题。
$ sudo USE="-native-extensions -python_targets_python2_7" \
       CFLAGS="-I/usr/arm-unknown-linux-gnueabi/usr/include/python3.6" \
       LDFLAGS="-L/usr/arm-unknown-linux-gnueabi/usr/lib" \
       arm-unknown-linux-gnueabi-emerge -auN1 --keep-going \
       "=portage-2.3.51-r1" gentoolkit
$ sudo USE="minimal -python_targets_python2_7" \
       CFLAGS="-I/usr/arm-unknown-linux-gnueabi/usr/include/python3.6" \
       LDFLAGS="-L/usr/arm-unknown-linux-gnueabi/usr/lib" \
       arm-unknown-linux-gnueabi-emerge -au --keep-going \
       vim
```

### Chroot
``` bash
  ###### chroot 到新的系统，进行接下来的配置
  ##  修改部分 make.conf 中的配置
  ##  删除 HOSTCC
  ##  删除 ROOT
  ##  删除 PKG_CONFIG_PATH
  ##  删除 PORTAGE_TMPDIR
  ##  替换 ${ARCH} 为 arm
$ cd /usr/arm-unknown-linux-gnueabi
$ sudo mount --bind /proc proc
$ sudo mount --bind /dev  dev
$ sudo mount --bind /sys  sys
$ sudo mount --bind /usr/portage usr/portage
$ sudo mount --bind /var/tmp/arm-unknown-linux-gnueabi var/tmp
$ sudo cp /etc/locale.gen /etc/resolv.conf etc/
$ sudo chroot .
(chroot) ldconfig
(chroot) locale-gen
(chroot) emerge -auN1 "=portage-2.3.51-r1"
(chroot) emerge -auDN --keep-going @world --exclude="portage"

```
