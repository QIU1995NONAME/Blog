---
layout: docs
title:  "虚拟机安装 Gentoo"
date:   2018-02-04
categories: Linux Gentoo
enable_mathjax: false
enable_mermaid: false
---
主要按照<https://wiki.gentoo.org>上面的指示进行操作。

<hr>
## 准备安装 Gentoo

### 主机环境
+ Linux 4.14.14-300.fc27.x86_64
+ VirtualBox 5.2.4

### 虚拟机基本配置
+ CPU 核心数: 4 (把核心给多一点肯定没错)
+ EFI:  启用
+ 内存： 8G
+ (SATA 0) 硬盘: 24G (普通 完全分配 SSD)
+ (SATA 1) 硬盘: 32G (普通 动态分配 SSD)
+ (SATA 2) 硬盘: 16G (完全写入 动态分配)
+ (SATA 4) 光盘: Fedora 27 Live CD (仅仅用作启动盘)
+ 虚拟网卡：2个
    0. Host-Only
    0. NAT

### 启动虚拟机

使用 Fedora 的 LiveCD 启动到界面，使得虚拟机可以连接到外部的网络。

<hr>
## 安装 Gentoo

### 使用 gdisk 为硬盘进行分区

由于是在新创建的虚拟机中，所以直接使用下述命令即可进行分区。

``` bash
(Fedora Live) $ gdisk /dev/sda
(Fedora Live) $ gdisk /dev/sdb
(Fedora Live) $ gdisk /dev/sdc
```

否则，建议使用 lsblk 等命令进行确认。以下是本人分区完成后使用 gdisk -l 的结果:

```
(Fedora Live) $ gdisk /dev/sda -l
Partition table scan:
  MBR: protective
  BSD: not present
  APM: not present
  GPT: present
...

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048          133119   64.0 MiB    EF00  EFI System
   2          133120         2099199   960.0 MiB   8300  Linux filesystem
   3         2099200        50331614   23.0 GiB    8300  Linux filesystem

(Fedora Live) $ gdisk /dev/sdb -l
...

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         8390655   4.0 GiB     8300  Linux filesystem
   2         8390656        67108830   28.0 GiB    8300  Linux filesystem

(Fedora Live) $ gdisk /dev/sdc -l
...

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         8390655   4.0 GiB     8200  Linux swap
   2         8390656        25167871   8.0 GiB     8300  Linux filesystem
   3        25167872        33554398   4.0 GiB     8300  Linux filesystem
```

### 格式化各个分区并挂载

``` bash
(Fedora Live) $ sudo mkfs.vfat  /dev/sda1
(Fedora Live) $ sudo mkfs.xfs   /dev/sda2
(Fedora Live) $ sudo mkfs.xfs   /dev/sda3
(Fedora Live) $ sudo mkfs.xfs   /dev/sdb1
(Fedora Live) $ sudo mkfs.xfs   /dev/sdb2
(Fedora Live) $ sudo mkswap     /dev/sdc1
(Fedora Live) $ sudo mkfs.xfs   /dev/sdc2
(Fedora Live) $ sudo mkfs.xfs   /dev/sdc3
(Fedora Live) $ sudo mkdir /mnt/gentoo
(Fedora Live) $ sudo mount /dev/sda3 /mnt/gentoo
(Fedora Live) $ cd /mnt/gentoo
(Fedora Live) $ sudo mkdir boot
(Fedora Live) $ sudo mkdir home
(Fedora Live) $ sudo mkdir AAAA
(Fedora Live) $ sudo mkdir var/tmp -p
(Fedora Live) $ sudo mount /dev/sda2 boot
(Fedora Live) $ sudo mount /dev/sdb1 home
(Fedora Live) $ sudo mount /dev/sdc2 var/tmp
(Fedora Live) $ cd boot
(Fedora Live) $ sudo mkdir efi
(Fedora Live) $ sudo mount /dev/sda1 efi
(Fedora Live) $ cd ../AAAA
(Fedora Live) $ sudo mkdir Normal
(Fedora Live) $ sudo mount /dev/sdb2 Normal
(Fedora Live) $ sudo mkdir Write
(Fedora Live) $ sudo mount /dev/sdc3 Write
(Fedora Live) $ sudo swapon /dev/sdc1
```

使用 lsblk 命令查看挂载情况

```
(Fedora Live) $ lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda           8:0    0   24G  0 disk 
├─sda1        8:1    0   64M  0 part /mnt/gentoo/boot/efi
├─sda2        8:2    0  960M  0 part /mnt/gentoo/boot
└─sda3        8:3    0   23G  0 part /mnt/gentoo
sdb           8:16   0   32G  0 disk 
├─sdb1        8:17   0    4G  0 part /mnt/gentoo/home
└─sdb2        8:18   0   28G  0 part /mnt/gentoo/AAAA/Normal
sdc           8:32   0   16G  0 disk 
├─sdc1        8:33   0    4G  0 part [SWAP]
├─sdc2        8:34   0    8G  0 part /mnt/gentoo/var/tmp
└─sdc3        8:35   0    4G  0 part /mnt/gentoo/AAAA/Write
```

### 下载并解压 stage4
使用 Fedora Live CD 中自带的 Firefox 即可完成下载。下载完成后将 stage4 拷贝到 /tmp。解压缩时按照官网提供的解压缩命令进行解压缩。

``` bash
(Fedora Live) $ sudo tar -xvjpf /tmp/stage4-*.tar.bz2 --xattrs --numeric-owner
```

### 配置 Gentoo 基础系统
此处主要按照官网的指示进行操作。但是建议将某些费时的操作放到之后完成。

``` bash
(Fedora Live) $ sudo mkdir /mnt/gentoo/etc/portage/repos.conf
(Fedora Live) $ sudo cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
(Fedora Live) $ sudo cp -L /etc/resolv.conf /mnt/gentoo/etc/
(Fedora Live) $ sudo mount -t proc /proc /mnt/gentoo/proc
(Fedora Live) $ sudo mount --rbind /sys /mnt/gentoo/sys
(Fedora Live) $ sudo mount --make-rslave /mnt/gentoo/sys
(Fedora Live) $ sudo mount --rbind /dev /mnt/gentoo/dev
(Fedora Live) $ sudo mount --make-rslave /mnt/gentoo/dev
```

### 切换到新环境并作出必要的配置

#### 进入新的环境
``` bash
(Fedora Live) $ sudo chroot /mnt/gentoo /bin/bash
(chroot gentoo) . /etc/profile
```

#### 安装 ebuild 数据库快照
``` bash
(chroot gentoo) echo -e "GENTOO_MIRRORS=\"http://mirrors.163.com/gentoo/\"" >> /etc/portage/make.conf
(chroot gentoo) emerge-webrsync
```

#### 选择一个 profile (default/linux/amd64/17.0/systemd)
``` bash
(chroot gentoo) eselect profile list
(chroot gentoo) eselect profile set <no.>
```

#### 创建用于 portage 的符号连接
``` bash
(chroot gentoo) cd /AAAA/Normal
(chroot gentoo) mkdir __ROOT_usr_portage_packages
(chroot gentoo) mkdir __ROOT_usr_portage_distfiles
(chroot gentoo) mkdir __ROOT_usr_src
(chroot gentoo) cd /usr
(chroot gentoo) ln -svf /AAAA/Normal/__ROOT_usr_src src
(chroot gentoo) cd portage
(chroot gentoo) ln -svf /AAAA/Normal/__ROOT_usr_portage_distfiles distfiles
(chroot gentoo) ln -svf /AAAA/Normal/__ROOT_usr_portage_packages  packages
```

#### 配置地区
``` bash
(chroot gentoo) echo -e "en_US.UTF-8 UTF-8\nzh_CN.UTF-8 UTF-8" > /etc/locale.gen
(chroot gentoo) locale-gen
(chroot gentoo) eselect locale list # 找到 en_US.UTF8，将序号补在下面的命令中
(chroot gentoo) eselect locale set <no.>
(chroot gentoo) env-update
```

#### 配置时区
``` bash
(chroot gentoo) echo "Asia/Shanghai" > /etc/timezone
(chroot gentoo) emerge --config sys-libs/timezone-data
```

#### 配置 /etc/portage/make.conf
``` bash
(chroot gentoo) cat > /etc/portage/make.conf << EOF
CFLAGS="-O2 -pipe"
GENTOO_MIRRORS="http://mirrors.163.com/gentoo/"
LC_MESSAGES=C

USE="bzip2 ipv6 lzma sse sse2 sse3 sse4 threads urandom"

PORTDIR="/usr/portage"
DISTDIR="/usr/portage/distfiles"
PKGDIR="/usr/portage/packages"

PYTHON_TARGETS="python3_6 python3_5 python3_4 python2_7" 
RUBY_TARGETS="ruby25 ruby24 ruby23 ruby22"

EOF
```

#### 配置 /var/lib/portage/world
``` bash
(chroot gentoo) cat > /var/lib/portage/world << EOF
app-admin/sudo
app-portage/gentoolkit
net-misc/networkmanager
sys-apps/gptfdisk
sys-apps/lsb-release
sys-apps/systemd
sys-boot/grub
sys-devel/bc
sys-fs/xfsprogs
sys-kernel/dracut
sys-kernel/gentoo-sources:4.4.87-r1 

EOF
```

#### 配置 /etc/fstab
``` bash
(chroot gentoo) cat > /etc/fstab << EOF
/dev/sda1   /boot/efi       vfat     umask=0077,shortname=winnt     0 2
/dev/sda2   /boot           xfs      defaults,noatime               0 0
/dev/sda3   /               xfs      defaults,noatime               0 0
/dev/sdb1   /home           xfs      defaults,noatime               0 0
/dev/sdb2   /AAAA/Normal    xfs      defaults,noatime               0 0
/dev/sdc1   swap            swap     defaults                       0 0
/dev/sdc2   /var/tmp        xfs      defaults,noatime               0 0
/dev/sdc3   /AAAA/Write     xfs      defaults,noatime               0 0

EOF
```

#### 配置 /etc/portage/package.use
``` bash
(chroot gentoo) cd /etc/portage/package.use
(chroot gentoo) rm * 
(chroot gentoo) cat > sys-boot_grub << EOF
sys-boot/grub grub_platforms_efi-64 grub_platforms_pc

EOF

(chroot gentoo) cat > sys-apps_systemd << EOF
sys-apps/systemd elfutils gnuefi sysv-utils

EOF
```

#### 配置用户密码
``` bash
(chroot gentoo) passwd                          # Root Password
(chroot gentoo) visudo                          # 将 wheel 组的设置解除注释
(chroot gentoo) useradd admin                   # 创建管理员用户 可以自己定义用户名
(chroot gentoo) passwd admin                    # 修改管理员用户密码
(chroot gentoo) usermod -a -G wheel admin       # 使得管理员用户真正拥有管理员权限
```

#### 重构整个系统
``` bash
(chroot gentoo) emerge -aef @world # 准备重构整个系统需要的源文件 顺便调整 USE Flag
(chroot gentoo) emerge -e @world
```

#### 安装内核
``` bash
(chroot gentoo) cd /usr/src/linux
(chroot gentoo) make defconfig                # 先进行一次默认值配置
(chroot gentoo) make menuconfig               # 根据 WIKI 进行自定义配置
(chroot gentoo) make -j8                      # 编译
(chroot gentoo) make modules_install          # 安装
(chroot gentoo) make install                  # 安装
(chroot gentoo) dracut --kver ${KVER}         # 生成initramfs
```

#### 配置 GRUB2
``` bash
(chroot gentoo) grub-install --efi-directory=/boot/efi
(chroot gentoo) cd /boot/efi/EFI
(chroot gentoo) cp gentoo/grubx64.efi BOOT/BOOTX64.EFI
(chroot gentoo) grub-mkconfig -o /boot/grub/grub.cfg
```

### 重新启动
+ 关机时，绝对不要强行关机。使用正常流程关机就好了。
+ 关机状态下，移除光盘。
+ 为虚拟机打快照。

<hr>
## 调整 Gentoo 系统

### 第一次配置 启动两个必要的网络服务
``` bash
(gentoo root) systemctl enable sshd
(gentoo root) systemctl enable NetworkManager
```

### 第二次配置 (可以通过 ssh 配置)

#### 重新选择一个 profile (default/linux/amd64/17.0/desktop/plasma/systemd)
``` bash
(gentoo root) sudo eselect profile list
(gentoo root) sudo eselect profile set <no.>
```

#### 重新配置 /var/lib/portage/world
``` bash
(gentoo root) cat > /var/lib/portage/world << EOF
app-admin/sudo
app-portage/gentoolkit
net-misc/networkmanager
sys-apps/gptfdisk
sys-apps/lsb-release
sys-apps/systemd
sys-boot/grub
sys-devel/bc
sys-fs/xfsprogs
sys-kernel/dracut
sys-kernel/gentoo-sources:4.4.87-r1

app-editors/vim
app-editors/emacs
app-shells/zsh
dev-vcs/git
app-text/tree
sys-kernel/linux-firmware
dev-db/mariadb
dev-lang/python:2.7
dev-lang/python:3.4
dev-lang/python:3.5
dev-lang/python:3.6
dev-lang/ruby:2.2
dev-lang/ruby:2.3
kde-plasma/plasma-meta:5
kde-apps/konsole:5
kde-apps/dolphin:5
kde-apps/ark:5
xfce-base/xfce4-meta
dev-cpp/gtkmm:2.4
dev-cpp/gtkmm:3.0
dev-db/mysql-workbench
dev-db/mysql-connector-c++
dev-db/postgresql:10
dev-db/postgresql:9.6
www-servers/nginx
sys-libs/ncurses
sys-libs/ncurses:5
dev-vcs/subversion
app-emulation/virtualbox-guest-additions
media-fonts/wqy-bitmapfont
media-fonts/wqy-microhei


EOF
```
#### 更新整个系统 ( 这一步，耗时跑了8个小时 )

``` bash
(gentoo) $ sudo emerge -auDN @world                 # 更新整个系统
(gentoo) $ sudo emerge -a --depclean                # 更新整个系统
(gentoo) $ sudo revdep-rebuild
```

#### 其它个性化设置
``` bash
(gentoo) $ sudo usermod -s /bin/zsh admin           # 设置 ZSH 为登陆 shell
(gentoo) $ sudo emerge -a --unmerge nano            # 本人不喜欢使用 nano
(gentoo) $ sudo hostnamectl set-hostname '....'     # 设置主机名称
(gentoo) $ sudo eselect editor list
(gentoo) $ sudo eselect editor set <no.>

```

### 清理多余的快照，并打下当前状态的快照(略)
